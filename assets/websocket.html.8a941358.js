import{r as e,o as t,a as o,b as n,d as p,F as c,e as s,c as l}from"./app.9dca4400.js";import{_ as r}from"./plugin-vue_export-helper.21dcd24c.js";const u={},k=n("h1",{id:"websocket",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#websocket","aria-hidden":"true"},"#"),s(" WebSocket")],-1),i={href:"https://datatracker.ietf.org/doc/html/rfc6455",target:"_blank",rel:"noopener noreferrer"},b=s("WebSocket"),d=s(" \u7528\u6765\u5728\u5BA2\u6237\u7AEF\u4E0E\u670D\u52A1\u5668\u95F4\u5EFA\u7ACB\u4E00\u4E2A\u53CC\u5DE5\u94FE\u63A5\u4EE5\u5B9E\u73B0\u53CC\u5411\u7684\u6570\u636E\u901A\u4FE1\uFF0C\u5B83\u5C5E\u4E8E OSI \u4E2D\u7684\u5E94\u7528\u5C42\u90E8\u5206"),m=s("\u672C\u7BC7\u6587\u7AE0\u76EE\u7684\u662F\u5B9E\u73B0\u7B80\u7248\u7684 websocket \u63A5\u53E3\uFF0C\u4EE5\u7406\u89E3 websocket \u901A\u4FE1\u8FC7\u7A0B\uFF0C\u63A5\u53E3\u89C4\u8303\u53C2\u8003"),h={href:"https://websockets.spec.whatwg.org/#the-websocket-interface",target:"_blank",rel:"noopener noreferrer"},g=s("\u8FD9\u91CC"),w=s("\u5B9E\u73B0"),f=l(`<h2 id="_1-\u6253\u5F00\u4E00\u4E2A\u63E1\u624B" tabindex="-1"><a class="header-anchor" href="#_1-\u6253\u5F00\u4E00\u4E2A\u63E1\u624B" aria-hidden="true">#</a> 1. \u6253\u5F00\u4E00\u4E2A\u63E1\u624B</h2><p>\u5EFA\u7ACB websocket \u9700\u8981\u63A5\u6536 url\u3001protocols\u3001client</p><ol><li>\u7ED9\u5B9A\u4E00\u4E2A url\uFF0C\u5982\u679C\u4EE5 ws \u5F00\u5934\uFF0C\u91C7\u7528 http \u534F\u8BAE\uFF0C\u5426\u5219\u91C7\u7528 https \u534F\u8BAE</li><li>\u521B\u5EFA\u4E00\u4E2A\u8BF7\u6C42\u5BF9\u8C61 request\uFF08\u53C2\u8003\u4E4B\u524D\u6587\u7AE0\uFF09\uFF0C\u5E76\u8BBE\u7F6E Upgrade\u3001Connection\u3001Sec-WebSocket-Key\u3001Sec-WebSocket-Version\u3001Sec-WebSocket-Protocol\u3001Sec-WebSocket-Extensions \u8BF7\u6C42\u5934</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    url<span class="token punctuation">,</span>
    client<span class="token punctuation">,</span>
    <span class="token string">&#39;service-workers&#39;</span><span class="token operator">:</span> <span class="token string">&#39;none&#39;</span><span class="token punctuation">,</span>
    referrer<span class="token operator">:</span> <span class="token string">&#39;no-referrer&#39;</span><span class="token punctuation">,</span>
    mode<span class="token operator">:</span> <span class="token string">&#39;websocket&#39;</span><span class="token punctuation">,</span>
    credentials<span class="token operator">:</span> <span class="token string">&#39;include&#39;</span><span class="token punctuation">,</span>
    cache<span class="token operator">:</span> <span class="token string">&#39;no-store&#39;</span><span class="token punctuation">,</span>
    redirect<span class="token operator">:</span> <span class="token string">&#39;error&#39;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> h <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
h<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&#39;Upgrade&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;websocket&#39;</span><span class="token punctuation">)</span> <span class="token comment">// \u6211\u4EEC\u5E0C\u671B\u5207\u6362\u5230 websockket \u534F\u8BAE</span>
h<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&#39;Connection&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;Upgrade&#39;</span><span class="token punctuation">)</span> <span class="token comment">// \u5E26\u6709 Upgrade \u5C31\u5FC5\u987B\u5E26\u6709 Connection \u5934</span>
<span class="token keyword">const</span> magic <span class="token operator">=</span> <span class="token string">&#39;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&#39;</span> <span class="token comment">// \u7528\u6765\u6821\u9A8C\u670D\u52A1\u5668\u8FD4\u56DE\u7684 key</span>
<span class="token keyword">function</span> <span class="token function">getRandomStr</span><span class="token punctuation">(</span><span class="token parameter">n <span class="token operator">=</span> <span class="token number">16</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token string">&#39;0123456789abcdefghigklmnopqrstuvwxyz&#39;</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token string">&#39;&#39;</span>
    <span class="token keyword">const</span> codeLen <span class="token operator">=</span> code<span class="token punctuation">.</span>length
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result <span class="token operator">+=</span> <span class="token operator">=</span> code<span class="token punctuation">[</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> codeLen<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result
<span class="token punctuation">}</span>
<span class="token keyword">const</span> rand <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">btoa</span><span class="token punctuation">(</span><span class="token function">getRandomStr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// Base64 \u7F16\u7801\u7684 16 \u5B57\u8282\uFF08byte\uFF09\u968F\u673A\u5B57\u7B26</span>
<span class="token comment">// js \u5B57\u7B26\u4E32\u7528 unit-16 \u5B58\u50A8\uFF0C\u6240\u4EE5\u8FD9\u91CC\u76F4\u63A5\u53D6 16 \u4E2A\u5B57\u7B26</span>
h<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&#39;Sec-WebSocket-Key&#39;</span><span class="token punctuation">,</span> rand<span class="token punctuation">)</span>
h<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&#39;Sec-WebSocket-Version&#39;</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span> <span class="token comment">// websocket \u7248\u672C\uFF0C\u89C4\u8303\u7ED9\u51FA\u7684\u662F 13</span>
h<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&#39;Sec-WebSocket-Protocol&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;chat&#39;</span><span class="token punctuation">)</span> <span class="token comment">// \u5BA2\u6237\u7AEF\u652F\u6301\u7684\u5B50\u534F\u8BAE\u7684\u5217\u8868</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><ol start="3"><li>\u901A\u8FC7 Fetch \u53D1\u9001\u8BF7\u6C42\uFF0C\u5BF9\u4E8E\u8BF7\u6C42\u7ED3\u679C\uFF1A <ul><li>\u5982\u679C\u7F51\u7EDC\u9519\u8BEF\u6216\u8005 statusCode \u4E0D\u662F 101\uFF0C\u8BA9 websocket \u5931\u8D25</li></ul></li></ol><h2 id="_2-websocket-\u63A5\u53E3" tabindex="-1"><a class="header-anchor" href="#_2-websocket-\u63A5\u53E3" aria-hidden="true">#</a> 2. WebSocket \u63A5\u53E3</h2><p>websocket \u50CF XHR \u4E00\u6837\u5305\u542B 4 \u79CD\u72B6\u6001-- CONNECTING\uFF080\uFF09\u3001OPEN\uFF081\uFF09\u3001CLOSING\uFF082\uFF09\u3001CLOSED\uFF083\uFF09</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">MWebsocket</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token constant">CONNECTION</span> <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">public</span> <span class="token constant">OPEN</span> <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token keyword">public</span> <span class="token constant">CLOSING</span> <span class="token operator">=</span> <span class="token number">2</span>
    <span class="token keyword">public</span> <span class="token constant">CLOSED</span> <span class="token operator">=</span> <span class="token number">3</span>
    <span class="token keyword">public</span> readyState <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">public</span> bufferAmount
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">public</span> readonly url<span class="token punctuation">,</span> <span class="token keyword">public</span> protocols <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">let</span> urlRecord <span class="token operator">=</span> <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
        
    <span class="token punctuation">}</span>
    
    <span class="token function-variable function">onopen</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function-variable function">onclose</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token function-variable function">send</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div>`,8);function _(y,S){const a=e("ExternalLinkIcon");return t(),o(c,null,[k,n("p",null,[n("a",i,[b,p(a)]),d]),n("p",null,[m,n("a",h,[g,p(a)]),w]),f],64)}var x=r(u,[["render",_]]);export{x as default};
